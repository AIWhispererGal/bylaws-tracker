â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                 WORKFLOW BUTTONS VISIBILITY ISSUE                            â•‘
â•‘                        Flow Diagram Analysis                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 1: SERVER-SIDE (Express + EJS)                        âœ… WORKING       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ User Request    â”‚
    â”‚ GET /dashboard/ â”‚
    â”‚ documents/:id   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Middleware: attachPermissions           â”‚
    â”‚ /src/middleware/permissions.js          â”‚
    â”‚                                         â”‚
    â”‚ 1. Get user_type from users table       â”‚
    â”‚ 2. Get org role from user_organizations â”‚
    â”‚ 3. Calculate hierarchy_level            â”‚
    â”‚ 4. Set req.userRole, req.permissions    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Route Handler                           â”‚
    â”‚ /src/routes/dashboard.js line 1048      â”‚
    â”‚                                         â”‚
    â”‚ canApprove = (hierarchy_level >= 3)     â”‚
    â”‚   â””â”€ admin (3) âœ…                       â”‚
    â”‚   â””â”€ owner (4) âœ…                       â”‚
    â”‚   â””â”€ member (2) âŒ                      â”‚
    â”‚   â””â”€ viewer (1) âŒ                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ EJS Template Render                     â”‚
    â”‚ /views/dashboard/document-viewer.ejs    â”‚
    â”‚ Line 382:                               â”‚
    â”‚                                         â”‚
    â”‚ <% if (userPermissions.canApprove ||    â”‚
    â”‚        userRole === 'admin' ||          â”‚
    â”‚        userRole === 'owner') { %>       â”‚
    â”‚                                         â”‚
    â”‚   <div class="workflow-progression">    â”‚
    â”‚     <button id="btn-approve-unmodified" â”‚
    â”‚             disabled>                   â”‚
    â”‚       Approve All Unmodified            â”‚
    â”‚     </button>                           â”‚
    â”‚     <button id="btn-progress-workflow"  â”‚
    â”‚             disabled>                   â”‚
    â”‚       Progress to Next Stage            â”‚
    â”‚     </button>                           â”‚
    â”‚   </div>                                â”‚
    â”‚ <% } %>                                 â”‚
    â”‚                                         â”‚
    â”‚ Result: Buttons rendered in HTML âœ…     â”‚
    â”‚         Initial state: DISABLED âœ…      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ HTML Sent   â”‚
              â”‚ to Browser  â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 2: CLIENT-SIDE (JavaScript in Browser)                âŒ BROKEN        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Browser parses HTML            â”‚
         â”‚ DOMContentLoaded event fires   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  TWO HANDLERS RUN!    â”‚
         â”‚                       â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ Handler 1â”‚         â”‚ Handler 2 â”‚
    â”‚ Line 1721â”‚         â”‚ Line 2636 â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚                      â”‚
         â”‚                      â”‚
         â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ updateWorkflow      â”‚  â”‚ refreshWorkflow              â”‚
â”‚ Progress()          â”‚  â”‚ Progress(documentId)         â”‚
â”‚ (OLD FUNCTION)      â”‚  â”‚ (NEW FUNCTION)               â”‚
â”‚ Lines 1878-1928     â”‚  â”‚ Lines 2454-2540              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     â”‚  â”‚                              â”‚
â”‚ âŒ PROBLEM:         â”‚  â”‚ âœ… CORRECT:                  â”‚
â”‚                     â”‚  â”‚                              â”‚
â”‚ Makes N API calls:  â”‚  â”‚ Makes 1 API call:            â”‚
â”‚ /api/workflow/      â”‚  â”‚ /api/workflow/documents/     â”‚
â”‚   sections/:id/     â”‚  â”‚   :id/progress-status        â”‚
â”‚   state (per sec)   â”‚  â”‚                              â”‚
â”‚                     â”‚  â”‚ Gets response:               â”‚
â”‚ Updates:            â”‚  â”‚ {                            â”‚
â”‚ âœ… Progress bar     â”‚  â”‚   stats: {                   â”‚
â”‚ âŒ Approve button   â”‚  â”‚     unmodifiedSections: 5,   â”‚
â”‚ âŒ Progress button  â”‚  â”‚     approvedSections: 3,     â”‚
â”‚                     â”‚  â”‚     canProgress: false       â”‚
â”‚ Result:             â”‚  â”‚   }                          â”‚
â”‚ Buttons stay        â”‚  â”‚ }                            â”‚
â”‚ DISABLED âŒ         â”‚  â”‚                              â”‚
â”‚                     â”‚  â”‚ Updates:                     â”‚
â”‚                     â”‚  â”‚ âœ… Progress bar              â”‚
â”‚                     â”‚  â”‚ âœ… Approve button (2476)     â”‚
â”‚                     â”‚  â”‚ âœ… Progress button (2490)    â”‚
â”‚                     â”‚  â”‚                              â”‚
â”‚                     â”‚  â”‚ Result:                      â”‚
â”‚                     â”‚  â”‚ Buttons ENABLED âœ…           â”‚
â”‚                     â”‚  â”‚ (if conditions met)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ CONFLICT! ğŸ”¥   â”‚
         â”‚                â”‚
         â”‚ Both run, but  â”‚
         â”‚ old function   â”‚
         â”‚ doesn't update â”‚
         â”‚ buttons        â”‚
         â”‚                â”‚
         â”‚ User sees:     â”‚
         â”‚ âŒ Disabled    â”‚
         â”‚    buttons     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                              THE FIX                                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OPTION 1: Delete OLD function (lines 1878-1928)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Before:                           â”‚ After:                                   â”‚
â”‚                                   â”‚                                          â”‚
â”‚ â”Œâ”€ Line 1721 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”Œâ”€ Line 1721 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚ â”‚ DOMContentLoaded     â”‚          â”‚ â”‚ DOMContentLoaded     â”‚                 â”‚
â”‚ â”‚   updateWorkflow     â”‚   â”€â”€â–º    â”‚ â”‚   (no longer exists) â”‚                 â”‚
â”‚ â”‚   Progress() âŒ      â”‚   FIX    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚                                          â”‚
â”‚                                   â”‚ â”Œâ”€ Line 2636 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚ â”Œâ”€ Line 1878 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”‚ DOMContentLoaded     â”‚                 â”‚
â”‚ â”‚ function update...() â”‚   â”€â”€â–º    â”‚ â”‚   refreshWorkflow    â”‚                 â”‚
â”‚ â”‚   (old, incomplete)  â”‚  DELETE  â”‚ â”‚   Progress(id) âœ…    â”‚                 â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                   â”‚                                          â”‚
â”‚ â”Œâ”€ Line 2636 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ Result:                                  â”‚
â”‚ â”‚ DOMContentLoaded     â”‚          â”‚ âœ… Only correct function runs            â”‚
â”‚ â”‚   refreshWorkflow    â”‚          â”‚ âœ… Buttons get enabled                   â”‚
â”‚ â”‚   Progress(id) âœ…    â”‚          â”‚ âœ… Workflow actions work                 â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚                                          â”‚
â”‚                                   â”‚                                          â”‚
â”‚ â”Œâ”€ Line 2454 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”Œâ”€ Line 2454 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚ â”‚ function refresh...()â”‚          â”‚ â”‚ function refresh...()â”‚                 â”‚
â”‚ â”‚   (new, complete) âœ… â”‚          â”‚ â”‚   (new, complete) âœ… â”‚                 â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

OPTION 2: Comment out old handler call (line 1724)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Before:                           â”‚ After:                                   â”‚
â”‚ document.addEventListener(        â”‚ document.addEventListener(               â”‚
â”‚   'DOMContentLoaded', () => {     â”‚   'DOMContentLoaded', () => {            â”‚
â”‚   loadAllSuggestionCounts();      â”‚   loadAllSuggestionCounts();             â”‚
â”‚   loadAllWorkflowStates();        â”‚   loadAllWorkflowStates();               â”‚
â”‚   updateWorkflowProgress(); âŒ    â”‚   // updateWorkflowProgress(); REMOVED  â”‚
â”‚ });                               â”‚ });                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      PERMISSION FLOW (VERIFIED âœ…)                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database Schema (Migration 024)                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ users        â”‚      â”‚ user_organizationsâ”‚      â”‚ organization_roles   â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ id           â”‚â”€â”€â”   â”‚ user_id          â”‚   â”Œâ”€â”€â”‚ id                   â”‚ â”‚
â”‚ â”‚ user_type_id â”‚  â”‚   â”‚ organization_id  â”‚   â”‚  â”‚ role_code            â”‚ â”‚
â”‚ â”‚ email        â”‚  â”‚   â”‚ role_id          â”‚â”€â”€â”€â”˜  â”‚ hierarchy_level      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚ is_active        â”‚      â”‚                      â”‚ â”‚
â”‚        â”‚          â””â”€â”€â”€â”¤ user_id (FK)     â”‚      â”‚ owner = 4            â”‚ â”‚
â”‚        â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ admin = 3 â† TARGET   â”‚ â”‚
â”‚        â”‚                                         â”‚ member = 2           â”‚ â”‚
â”‚        â–¼                                         â”‚ viewer = 1           â”‚ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚ user_types   â”‚                                                         â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    Permission Check:                                    â”‚
â”‚ â”‚ type_code    â”‚    if (hierarchy_level >= 3) {                          â”‚
â”‚ â”‚ global_perms â”‚      canApprove = true; âœ…                              â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    }                                                     â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                          VERIFICATION CHECKLIST                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Server-Side (ALL âœ…):
  âœ… attachPermissions middleware runs
  âœ… getUserType() fetches from users.user_type_id
  âœ… getUserRole() fetches from user_organizations.role_id
  âœ… hierarchy_level correctly maps (admin=3, owner=4)
  âœ… canApprove = (hierarchy_level >= 3) calculation correct
  âœ… userPermissions object passed to template
  âœ… EJS template renders workflow section
  âœ… Buttons included in HTML with correct IDs

Client-Side (BROKEN âŒ):
  âŒ Old updateWorkflowProgress() runs
  âŒ Doesn't update button elements
  âŒ Buttons remain disabled
  âœ… (After fix) refreshWorkflowProgress() runs
  âœ… (After fix) Updates button states correctly

API Layer (ALL âœ…):
  âœ… /api/workflow/documents/:id/progress-status exists
  âœ… Returns stats.unmodifiedSections
  âœ… Returns canProgress flag
  âœ… Response structure correct

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                              CONCLUSION                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Classification:     JavaScript Function Conflict (NOT permissions)
Severity:          Medium (workflow feature unusable for admins)
Complexity:        LOW (simple function removal)
Fix Time:          2 minutes
Test Time:         5 minutes
Risk:              LOW (removing duplicate code)
Rollback:          Easy (git checkout)

Root Cause:        Two DOMContentLoaded handlers calling different functions
                   Old function incomplete (doesn't update buttons)
                   New function correct (updates everything)

Impact:            Admins/Owners cannot use workflow progression features
                   Buttons render but stay disabled
                   No visible errors (silent failure)

Solution:          Remove old function OR comment out old handler call
                   Let only new function run
                   Buttons will enable correctly

Verified Working:  âœ… All permission system components
                   âœ… All database schema
                   âœ… All middleware
                   âœ… All API endpoints
                   âœ… Server-side rendering

NOT Working:       âŒ JavaScript button initialization (this is the only issue)
