╔══════════════════════════════════════════════════════════════════════════════╗
║                 WORKFLOW BUTTONS VISIBILITY ISSUE                            ║
║                        Flow Diagram Analysis                                 ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌──────────────────────────────────────────────────────────────────────────────┐
│ PHASE 1: SERVER-SIDE (Express + EJS)                        ✅ WORKING       │
└──────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────┐
    │ User Request    │
    │ GET /dashboard/ │
    │ documents/:id   │
    └────────┬────────┘
             │
             ▼
    ┌─────────────────────────────────────────┐
    │ Middleware: attachPermissions           │
    │ /src/middleware/permissions.js          │
    │                                         │
    │ 1. Get user_type from users table       │
    │ 2. Get org role from user_organizations │
    │ 3. Calculate hierarchy_level            │
    │ 4. Set req.userRole, req.permissions    │
    └────────────────┬────────────────────────┘
                     │
                     ▼
    ┌─────────────────────────────────────────┐
    │ Route Handler                           │
    │ /src/routes/dashboard.js line 1048      │
    │                                         │
    │ canApprove = (hierarchy_level >= 3)     │
    │   └─ admin (3) ✅                       │
    │   └─ owner (4) ✅                       │
    │   └─ member (2) ❌                      │
    │   └─ viewer (1) ❌                      │
    └────────────────┬────────────────────────┘
                     │
                     ▼
    ┌─────────────────────────────────────────┐
    │ EJS Template Render                     │
    │ /views/dashboard/document-viewer.ejs    │
    │ Line 382:                               │
    │                                         │
    │ <% if (userPermissions.canApprove ||    │
    │        userRole === 'admin' ||          │
    │        userRole === 'owner') { %>       │
    │                                         │
    │   <div class="workflow-progression">    │
    │     <button id="btn-approve-unmodified" │
    │             disabled>                   │
    │       Approve All Unmodified            │
    │     </button>                           │
    │     <button id="btn-progress-workflow"  │
    │             disabled>                   │
    │       Progress to Next Stage            │
    │     </button>                           │
    │   </div>                                │
    │ <% } %>                                 │
    │                                         │
    │ Result: Buttons rendered in HTML ✅     │
    │         Initial state: DISABLED ✅      │
    └────────────────┬────────────────────────┘
                     │
                     ▼
              ┌─────────────┐
              │ HTML Sent   │
              │ to Browser  │
              └──────┬──────┘
                     │
                     │
┌────────────────────┴─────────────────────────────────────────────────────────┐
│ PHASE 2: CLIENT-SIDE (JavaScript in Browser)                ❌ BROKEN        │
└──────────────────────────────────────────────────────────────────────────────┘

         ┌────────────────────────────────┐
         │ Browser parses HTML            │
         │ DOMContentLoaded event fires   │
         └───────────┬────────────────────┘
                     │
         ┌───────────┴───────────┐
         │  TWO HANDLERS RUN!    │
         │                       │
    ┌────▼─────┐         ┌──────▼────┐
    │ Handler 1│         │ Handler 2 │
    │ Line 1721│         │ Line 2636 │
    └────┬─────┘         └──────┬────┘
         │                      │
         │                      │
         ▼                      ▼
┌─────────────────────┐  ┌──────────────────────────────┐
│ updateWorkflow      │  │ refreshWorkflow              │
│ Progress()          │  │ Progress(documentId)         │
│ (OLD FUNCTION)      │  │ (NEW FUNCTION)               │
│ Lines 1878-1928     │  │ Lines 2454-2540              │
├─────────────────────┤  ├──────────────────────────────┤
│                     │  │                              │
│ ❌ PROBLEM:         │  │ ✅ CORRECT:                  │
│                     │  │                              │
│ Makes N API calls:  │  │ Makes 1 API call:            │
│ /api/workflow/      │  │ /api/workflow/documents/     │
│   sections/:id/     │  │   :id/progress-status        │
│   state (per sec)   │  │                              │
│                     │  │ Gets response:               │
│ Updates:            │  │ {                            │
│ ✅ Progress bar     │  │   stats: {                   │
│ ❌ Approve button   │  │     unmodifiedSections: 5,   │
│ ❌ Progress button  │  │     approvedSections: 3,     │
│                     │  │     canProgress: false       │
│ Result:             │  │   }                          │
│ Buttons stay        │  │ }                            │
│ DISABLED ❌         │  │                              │
│                     │  │ Updates:                     │
│                     │  │ ✅ Progress bar              │
│                     │  │ ✅ Approve button (2476)     │
│                     │  │ ✅ Progress button (2490)    │
│                     │  │                              │
│                     │  │ Result:                      │
│                     │  │ Buttons ENABLED ✅           │
│                     │  │ (if conditions met)          │
└─────────────────────┘  └──────────────────────────────┘
         │                        │
         └────────┬───────────────┘
                  │
                  ▼
         ┌────────────────┐
         │ CONFLICT! 🔥   │
         │                │
         │ Both run, but  │
         │ old function   │
         │ doesn't update │
         │ buttons        │
         │                │
         │ User sees:     │
         │ ❌ Disabled    │
         │    buttons     │
         └────────────────┘

╔══════════════════════════════════════════════════════════════════════════════╗
║                              THE FIX                                         ║
╚══════════════════════════════════════════════════════════════════════════════╝

OPTION 1: Delete OLD function (lines 1878-1928)
┌──────────────────────────────────────────────────────────────────────────────┐
│ Before:                           │ After:                                   │
│                                   │                                          │
│ ┌─ Line 1721 ─────────┐          │ ┌─ Line 1721 ─────────┐                 │
│ │ DOMContentLoaded     │          │ │ DOMContentLoaded     │                 │
│ │   updateWorkflow     │   ──►    │ │   (no longer exists) │                 │
│ │   Progress() ❌      │   FIX    │ └──────────────────────┘                 │
│ └──────────────────────┘          │                                          │
│                                   │ ┌─ Line 2636 ─────────┐                 │
│ ┌─ Line 1878 ─────────┐          │ │ DOMContentLoaded     │                 │
│ │ function update...() │   ──►    │ │   refreshWorkflow    │                 │
│ │   (old, incomplete)  │  DELETE  │ │   Progress(id) ✅    │                 │
│ └──────────────────────┘          │ └──────────────────────┘                 │
│                                   │                                          │
│ ┌─ Line 2636 ─────────┐          │ Result:                                  │
│ │ DOMContentLoaded     │          │ ✅ Only correct function runs            │
│ │   refreshWorkflow    │          │ ✅ Buttons get enabled                   │
│ │   Progress(id) ✅    │          │ ✅ Workflow actions work                 │
│ └──────────────────────┘          │                                          │
│                                   │                                          │
│ ┌─ Line 2454 ─────────┐          │ ┌─ Line 2454 ─────────┐                 │
│ │ function refresh...()│          │ │ function refresh...()│                 │
│ │   (new, complete) ✅ │          │ │   (new, complete) ✅ │                 │
│ └──────────────────────┘          │ └──────────────────────┘                 │
└──────────────────────────────────────────────────────────────────────────────┘

OPTION 2: Comment out old handler call (line 1724)
┌──────────────────────────────────────────────────────────────────────────────┐
│ Before:                           │ After:                                   │
│ document.addEventListener(        │ document.addEventListener(               │
│   'DOMContentLoaded', () => {     │   'DOMContentLoaded', () => {            │
│   loadAllSuggestionCounts();      │   loadAllSuggestionCounts();             │
│   loadAllWorkflowStates();        │   loadAllWorkflowStates();               │
│   updateWorkflowProgress(); ❌    │   // updateWorkflowProgress(); REMOVED  │
│ });                               │ });                                      │
└──────────────────────────────────────────────────────────────────────────────┘

╔══════════════════════════════════════════════════════════════════════════════╗
║                      PERMISSION FLOW (VERIFIED ✅)                           ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│ Database Schema (Migration 024)                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ ┌──────────────┐      ┌───────────────────┐      ┌──────────────────────┐ │
│ │ users        │      │ user_organizations│      │ organization_roles   │ │
│ ├──────────────┤      ├───────────────────┤      ├──────────────────────┤ │
│ │ id           │──┐   │ user_id          │   ┌──│ id                   │ │
│ │ user_type_id │  │   │ organization_id  │   │  │ role_code            │ │
│ │ email        │  │   │ role_id          │───┘  │ hierarchy_level      │ │
│ └──────────────┘  │   │ is_active        │      │                      │ │
│        │          └───┤ user_id (FK)     │      │ owner = 4            │ │
│        │              └───────────────────┘      │ admin = 3 ← TARGET   │ │
│        │                                         │ member = 2           │ │
│        ▼                                         │ viewer = 1           │ │
│ ┌──────────────┐                                └──────────────────────┘ │
│ │ user_types   │                                                         │
│ ├──────────────┤    Permission Check:                                    │
│ │ type_code    │    if (hierarchy_level >= 3) {                          │
│ │ global_perms │      canApprove = true; ✅                              │
│ └──────────────┘    }                                                     │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘

╔══════════════════════════════════════════════════════════════════════════════╗
║                          VERIFICATION CHECKLIST                              ║
╚══════════════════════════════════════════════════════════════════════════════╝

Server-Side (ALL ✅):
  ✅ attachPermissions middleware runs
  ✅ getUserType() fetches from users.user_type_id
  ✅ getUserRole() fetches from user_organizations.role_id
  ✅ hierarchy_level correctly maps (admin=3, owner=4)
  ✅ canApprove = (hierarchy_level >= 3) calculation correct
  ✅ userPermissions object passed to template
  ✅ EJS template renders workflow section
  ✅ Buttons included in HTML with correct IDs

Client-Side (BROKEN ❌):
  ❌ Old updateWorkflowProgress() runs
  ❌ Doesn't update button elements
  ❌ Buttons remain disabled
  ✅ (After fix) refreshWorkflowProgress() runs
  ✅ (After fix) Updates button states correctly

API Layer (ALL ✅):
  ✅ /api/workflow/documents/:id/progress-status exists
  ✅ Returns stats.unmodifiedSections
  ✅ Returns canProgress flag
  ✅ Response structure correct

╔══════════════════════════════════════════════════════════════════════════════╗
║                              CONCLUSION                                      ║
╚══════════════════════════════════════════════════════════════════════════════╝

Classification:     JavaScript Function Conflict (NOT permissions)
Severity:          Medium (workflow feature unusable for admins)
Complexity:        LOW (simple function removal)
Fix Time:          2 minutes
Test Time:         5 minutes
Risk:              LOW (removing duplicate code)
Rollback:          Easy (git checkout)

Root Cause:        Two DOMContentLoaded handlers calling different functions
                   Old function incomplete (doesn't update buttons)
                   New function correct (updates everything)

Impact:            Admins/Owners cannot use workflow progression features
                   Buttons render but stay disabled
                   No visible errors (silent failure)

Solution:          Remove old function OR comment out old handler call
                   Let only new function run
                   Buttons will enable correctly

Verified Working:  ✅ All permission system components
                   ✅ All database schema
                   ✅ All middleware
                   ✅ All API endpoints
                   ✅ Server-side rendering

NOT Working:       ❌ JavaScript button initialization (this is the only issue)
