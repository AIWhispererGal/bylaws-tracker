# ISSUE REPORTS - Bylaws Amendment Tracker
## Detailed Bug Reports for All Priority Issues

**Generated By**: Hive Mind Code Review Swarm
**Date**: 2025-10-14
**Swarm ID**: swarm-1760488231719-uskyostv0

---

## TABLE OF CONTENTS

1. [Issue #1 - Setup Wizard Loses Hierarchy Configuration](#issue-1)
2. [Issue #2 - Global Admin Missing Cross-Org Permissions](#issue-2)
3. [Issue #3 - Org Admin User Storage (NO ISSUE)](#issue-3)
4. [Issue #4 - Missing Default Workflow Initialization](#issue-4)
5. [Issue #5 - 10-Level Support Configuration Gap](#issue-5)
6. [Issue #6 - Section Editing Operations Missing](#issue-6)

---

<a name="issue-1"></a>
## ðŸ”´ ISSUE #1: SETUP WIZARD LOSES HIERARCHY CONFIGURATION [CRITICAL]

### Issue Summary

**Priority**: ðŸ”´ CRITICAL (P1)
**Component**: Setup Wizard / Organization Creation
**Severity**: HIGH - Breaks core functionality
**Affected Users**: All new organizations
**Status**: âŒ BROKEN

### Description

When users complete the setup wizard and customize their document hierarchy (e.g., choosing "Article > Section > Subsection" instead of the defaults), the system appears to save their choices but actually **discards them**. The hierarchy configuration is stored in the session but never persisted to the database. When the application later loads the organization configuration, it finds NULL in the database and falls back to hardcoded defaults, losing the user's customization.

### Steps to Reproduce

1. Start setup wizard at `/setup`
2. Enter organization details
3. Choose document type and customize hierarchy:
   - Level 0: "Article" â†’ Change to "Chapter"
   - Level 1: "Section" â†’ Change to "Clause"
4. Upload document and complete setup
5. Wizard shows "Success! Setup complete"
6. Navigate to dashboard
7. **OBSERVE**: Document displays with "Article" and "Section" instead of "Chapter" and "Clause"

### Expected Behavior

- User's custom hierarchy configuration persisted to database
- Organization loads with custom level names
- Document displays using user's chosen terminology

### Actual Behavior

- Custom configuration stored in session only
- Database organization record has NULL for `hierarchy_config`
- System falls back to hardcoded defaults
- User's choices completely lost

### Root Cause

**File**: `src/routes/setup.js`
**Function**: `processSetupData()`
**Lines**: 610-623

```javascript
// Current code (WRONG)
const { data, error } = await supabase
  .from('organizations')
  .insert({
    name: setupData.organization.name,
    slug: setupData.organization.slug,
    settings: {},
    // âŒ MISSING: hierarchy_config field
    created_at: new Date().toISOString()
  })
  .select()
  .single();
```

The `hierarchy_config` field exists in the database schema but is never populated during setup. The setup wizard stores the configuration in `req.session.setupData.documentStructure` but this session data is not transferred to the database.

### Code Analysis

**Setup Flow**:
1. **Line 221-235**: User selects document type, stored in session
2. **Line 251-268**: User customizes hierarchy, stored in session
3. **Line 584-656**: `processSetupData()` creates organization
4. **Line 610-623**: Organization insert **MISSING hierarchy_config**
5. **Line 715-730**: Setup completes, session cleared

**Config Loading Flow**:
```javascript
// src/config/organizationConfig.js:286-309
async function loadOrganizationConfig(orgId) {
  const org = await getOrganization(orgId);

  if (!org.hierarchy_config) {
    // âŒ Falls back to defaults because hierarchy_config is NULL
    return DEFAULT_CONFIG;
  }

  return validateConfig(org.hierarchy_config);
}
```

### Impact Assessment

**Severity**: HIGH

**Affected Functionality**:
- âœ… Organization creation succeeds
- âœ… User creation succeeds
- âœ… Document import succeeds
- âŒ **Custom hierarchy configuration LOST**
- âŒ **User confusion** - wizard says success but choices ignored
- âŒ **Data inconsistency** - session vs database

**User Impact**:
- **Legal organizations**: Need specific terminology (Article vs Section vs Clause)
- **Compliance teams**: Require exact naming for regulations
- **Government agencies**: Have mandated hierarchy structures
- **ALL USERS**: Waste time re-customizing after realizing defaults used

### Proposed Fix

**File**: `src/routes/setup.js`
**Lines**: 610-623

```javascript
// Fixed code
const { data, error } = await supabase
  .from('organizations')
  .insert({
    name: setupData.organization.name,
    slug: setupData.organization.slug,
    settings: {},
    hierarchy_config: setupData.documentStructure, // âœ… ADD THIS LINE
    created_at: new Date().toISOString()
  })
  .select()
  .single();
```

### Testing Plan

**Unit Tests**:
```javascript
describe('processSetupData', () => {
  test('should persist hierarchy_config to database', async () => {
    const setupData = {
      organization: { name: 'Test Org', slug: 'test-org' },
      documentStructure: {
        maxDepth: 3,
        levels: [
          { depth: 0, name: 'Chapter' },
          { depth: 1, name: 'Clause' }
        ]
      }
    };

    await processSetupData(req, setupData);

    const org = await supabase
      .from('organizations')
      .select('hierarchy_config')
      .eq('slug', 'test-org')
      .single();

    expect(org.hierarchy_config).toEqual(setupData.documentStructure);
  });
});
```

**Integration Test**:
```javascript
test('complete setup flow preserves custom hierarchy', async () => {
  // 1. POST /setup/organization
  // 2. POST /setup/document-type with custom hierarchy
  // 3. POST /setup/import
  // 4. GET /setup/process
  // 5. Verify organization.hierarchy_config in database
  // 6. GET /dashboard
  // 7. Verify document displays with custom level names
});
```

**Manual QA**:
1. Complete setup with custom hierarchy
2. Verify success page shows correct names
3. Navigate to dashboard
4. Verify document sections use custom terminology
5. Refresh page (clear session cache)
6. Verify custom names persist

### Estimated Effort

- **Implementation**: 1 hour (1 line change + validation)
- **Unit Tests**: 1 hour
- **Integration Tests**: 1 hour
- **Manual QA**: 1 hour
- **TOTAL**: 4 hours

### Related Issues

- Depends on: None
- Blocks: Dashboard display, User onboarding
- Related to: Issue #5 (10-level support)

### Notes

This is a **data loss bug** that appears to work but silently discards user input. High priority because it affects every new organization and undermines user trust in the system.

---

<a name="issue-2"></a>
## ðŸ”´ ISSUE #2: GLOBAL ADMIN MISSING CROSS-ORG PERMISSIONS [CRITICAL]

### Issue Summary

**Priority**: ðŸ”´ CRITICAL (P2)
**Component**: RLS Policies / Permissions
**Severity**: HIGH - Security feature incomplete
**Affected Users**: Global administrators, first org users
**Status**: âŒ BROKEN

### Description

The global admin feature was added in migration 007 but only partially implemented. Global admins can see organizations, documents, and sections across all organizations, but they are **blocked** from accessing suggestions, workflows, and user management. This makes the global admin role nearly useless as they can view data but not manage it.

### Steps to Reproduce

1. Login as global admin (first user of first organization)
2. Navigate to `/admin/suggestions` for Organization B
3. **OBSERVE**: 403 Forbidden or empty list
4. Navigate to `/admin/workflows` for Organization B
5. **OBSERVE**: Cannot approve workflow stages
6. Navigate to `/admin/users` for Organization B
7. **OBSERVE**: Cannot manage users

### Expected Behavior

Global admin should have **ALL permissions** across **ALL organizations**:
- âœ… View all organizations
- âœ… View all documents and sections
- âœ… View and manage all suggestions
- âœ… Approve/reject suggestions across orgs
- âœ… Manage workflows for all orgs
- âœ… Manage users across all orgs

### Actual Behavior

Global admin has **PARTIAL permissions**:
- âœ… Can view organizations
- âœ… Can view documents
- âœ… Can view sections
- âŒ **BLOCKED from suggestions**
- âŒ **BLOCKED from workflows**
- âŒ **BLOCKED from user management**

### Root Cause

**Location**: Multiple database migration files

**The Problem**: Migration 007 added the `is_global_admin()` helper function and updated RLS policies for 5 tables, but **forgot to update 6 other critical tables**.

**Tables Updated** âœ…:
- `organizations`
- `documents`
- `document_sections`
- `workflow_templates`
- `workflow_stages`

**Tables MISSED** âŒ:
- `suggestions`
- `suggestion_sections`
- `suggestion_votes`
- `document_workflows`
- `section_workflow_states`
- `user_organizations`

### Code Analysis

**Current RLS Policy** (WRONG):
```sql
-- File: database/migrations/005_implement_proper_rls_FIXED.sql
CREATE POLICY "users_select_own_org" ON suggestions
FOR SELECT TO authenticated
USING (
  organization_id IN (
    SELECT organization_id
    FROM user_organizations
    WHERE user_id = auth.uid()
  )
  -- âŒ MISSING: OR is_global_admin(auth.uid())
);
```

**Should Be** (CORRECT):
```sql
CREATE POLICY "users_select_own_org_or_global_admin" ON suggestions
FOR SELECT TO authenticated
USING (
  is_global_admin(auth.uid())  -- âœ… Global admins bypass org filter
  OR
  organization_id IN (
    SELECT organization_id
    FROM user_organizations
    WHERE user_id = auth.uid()
  )
);
```

### Affected Tables & Operations

Each table needs updates for 4 operations (SELECT, INSERT, UPDATE, DELETE):

**1. suggestions** (4 policies)
- `users_select_own_org` - Add global admin check
- `users_insert_own_org` - Add global admin check
- `users_update_own_org` - Add global admin check
- `users_delete_own_org` - Add global admin check

**2. suggestion_sections** (4 policies)
- Similar pattern

**3. suggestion_votes** (4 policies)
- Similar pattern

**4. document_workflows** (4 policies)
- Similar pattern

**5. section_workflow_states** (4 policies)
- Similar pattern

**6. user_organizations** (4 policies)
- Similar pattern

**TOTAL**: 24 RLS policies need updating

### Impact Assessment

**Severity**: HIGH

**Security Impact**:
- âœ… No data leakage (users still isolated)
- âŒ Feature incomplete (global admin broken)
- âŒ First user stuck with limited permissions
- âŒ Cross-org management impossible

**Business Impact**:
- Platform administrators cannot manage the system
- Support team cannot help users across orgs
- First organization user has "superuser" role but can't use it
- Multi-tenant feature partially broken

### Proposed Fix

**New Migration**: `database/migrations/013_fix_global_admin_rls.sql`

```sql
-- Fix RLS policies for suggestions table
DROP POLICY IF EXISTS "users_select_own_org" ON suggestions;
CREATE POLICY "users_select_own_org_or_global_admin" ON suggestions
FOR SELECT TO authenticated
USING (
  is_global_admin(auth.uid())
  OR
  organization_id IN (
    SELECT organization_id FROM user_organizations
    WHERE user_id = auth.uid()
  )
);

DROP POLICY IF EXISTS "users_insert_own_org" ON suggestions;
CREATE POLICY "users_insert_own_org_or_global_admin" ON suggestions
FOR INSERT TO authenticated
WITH CHECK (
  is_global_admin(auth.uid())
  OR
  organization_id IN (
    SELECT organization_id FROM user_organizations
    WHERE user_id = auth.uid()
  )
);

-- Repeat for UPDATE and DELETE operations
-- Then repeat entire pattern for other 5 tables
-- Total: 24 policy updates
```

### Testing Plan

**Security Tests**:
```javascript
describe('Global Admin RLS', () => {
  let globalAdmin, orgAdmin, regularUser;

  beforeAll(async () => {
    // Create test users
    globalAdmin = await createUser({ is_global_admin: true });
    orgAdmin = await createUser({ role: 'org_admin', org_id: 'org-1' });
    regularUser = await createUser({ role: 'member', org_id: 'org-1' });
  });

  test('global admin can view suggestions across all orgs', async () => {
    const { data } = await supabase
      .from('suggestions')
      .select('*')
      .auth(globalAdmin.token);

    expect(data.length).toBeGreaterThan(0);
    expect(data).toContainOrganization('org-1');
    expect(data).toContainOrganization('org-2');
  });

  test('org admin can only view own org suggestions', async () => {
    const { data } = await supabase
      .from('suggestions')
      .select('*')
      .auth(orgAdmin.token);

    expect(data.every(s => s.organization_id === 'org-1')).toBe(true);
  });

  test('global admin can approve workflows in any org', async () => {
    const section = await createSectionInOrg('org-2');
    const { error } = await supabase
      .rpc('advance_section_to_next_stage', {
        section_id: section.id
      })
      .auth(globalAdmin.token);

    expect(error).toBeNull();
  });

  test('global admin can manage users across orgs', async () => {
    const { data, error } = await supabase
      .from('user_organizations')
      .update({ role: 'admin' })
      .eq('user_id', regularUser.id)
      .auth(globalAdmin.token);

    expect(error).toBeNull();
  });
});
```

**Integration Tests**:
```javascript
test('global admin complete workflow across organizations', async () => {
  // 1. Login as global admin
  // 2. Create suggestion in Org A
  // 3. Approve suggestion in Org B
  // 4. Advance workflow stage in Org C
  // 5. Manage user in Org D
  // All should succeed
});

test('regular admin isolated to own organization', async () => {
  // 1. Login as org admin for Org A
  // 2. Try to view suggestions in Org B â†’ 403
  // 3. Try to approve workflow in Org B â†’ 403
  // 4. Try to manage users in Org B â†’ 403
});
```

**Manual QA**:
1. Login as global admin (first user email from setup)
2. Verify "Global Admin" badge in UI
3. Test each operation:
   - View suggestions across all orgs
   - Create/approve suggestions in different orgs
   - Advance workflow stages in different orgs
   - Manage users in different orgs
4. Login as regular org admin
5. Verify isolation to their organization only

### Estimated Effort

- **Migration Creation**: 2 hours (24 policies)
- **Security Tests**: 3 hours (comprehensive coverage)
- **Integration Tests**: 2 hours
- **Manual QA**: 1 hour
- **TOTAL**: 8 hours

### Related Issues

- Depends on: None (standalone fix)
- Blocks: Global admin feature usability
- Related to: Migration 007 (incomplete implementation)

### Notes

This is a **security feature gap** that makes the global admin role incomplete. It's not a security vulnerability (no unauthorized access), but it breaks the intended multi-tenant management capabilities. High priority because it affects platform administrators and blocks cross-org support.

---

<a name="issue-3"></a>
## âœ… ISSUE #3: ORG ADMIN USER STORAGE (NO ISSUE FOUND)

### Issue Summary

**Priority**: ðŸŸ¢ HIGH (P3)
**Component**: User Creation / Setup Wizard
**Severity**: NONE - Working as designed
**Affected Users**: None
**Status**: âœ… WORKING

### Description

Initial concern was that organization admin users might not be properly stored during setup. After comprehensive code analysis by the Coder Agent, the user creation flow is **fully functional** and properly implemented.

### Analysis Performed

**Files Reviewed**:
- `src/routes/setup.js` (775 lines)
- `src/routes/auth.js` (412 lines)
- Database migrations related to users

**Flow Verified**:
1. âœ… Supabase Auth user created (Line 144-162)
2. âœ… Email auto-confirmed
3. âœ… User metadata set (`setup_user: true`)
4. âœ… User info stored in session (Line 165-172)
5. âœ… Password stored temporarily for auto-login (Line 174-175)
6. âœ… Organization created (Line 610-623)
7. âœ… `user_organizations` record created (Line 634-652)
8. âœ… Correct role assigned (superuser for first, org_admin for others)
9. âœ… Auto-login executed (Line 476-490)
10. âœ… JWT tokens stored in session (Line 486-489)

### Evidence of Correct Implementation

```javascript
// src/routes/setup.js:144-162
const { data: authUser, error: authError } = await supabase.auth.admin.createUser({
  email: adminData.admin_email,
  password: adminData.admin_password,
  email_confirm: true,  // âœ… Auto-confirmed
  user_metadata: {
    setup_user: true,  // âœ… Flag for setup wizard
    created_at: new Date().toISOString()
  }
});

// src/routes/setup.js:634-652
const userRole = adminUser.is_first_org ? 'superuser' : 'org_admin';  // âœ… Correct role
await supabase.from('user_organizations').insert({
  user_id: adminUser.user_id,  // âœ… Links to auth user
  organization_id: data.id,  // âœ… Links to org
  role: userRole,  // âœ… Proper role
  created_at: new Date().toISOString()
});

// src/routes/setup.js:476-490
const { data: authData } = await supabase.auth.signInWithPassword({
  email: adminUser.email,
  password: req.session.adminPassword  // âœ… Auto-login
});

req.session.supabaseJWT = authData.session.access_token;  // âœ… JWT stored
req.session.supabaseRefreshToken = authData.session.refresh_token;
req.session.supabaseUser = authData.user;
```

### Code Quality Assessment

**Strengths**:
- âœ… Proper error handling at each step
- âœ… Transaction-like flow (fails gracefully)
- âœ… Security: Email auto-confirmed (no verification needed)
- âœ… Security: Password cleared after auto-login
- âœ… Role assignment logic correct
- âœ… First user becomes superuser automatically

**No Issues Found**:
- Users table populated correctly
- `user_organizations` linking works
- JWT tokens properly stored
- Auto-login succeeds
- Session persistence working

### Testing Recommendation

While the code is correct, add integration tests to prevent future regressions:

```javascript
describe('User Creation During Setup', () => {
  test('should create admin user and link to organization', async () => {
    const setupData = {
      organization: { name: 'Test Org', slug: 'test-org' },
      admin: {
        admin_email: 'admin@test.com',
        admin_password: 'SecurePass123!'
      }
    };

    await processSetupData(req, setupData);

    // Verify auth user exists
    const { data: authUser } = await supabase.auth.admin.getUserByEmail(
      'admin@test.com'
    );
    expect(authUser).toBeDefined();
    expect(authUser.email_confirmed_at).not.toBeNull();

    // Verify user_organizations link
    const { data: userOrg } = await supabase
      .from('user_organizations')
      .select('role')
      .eq('user_id', authUser.id)
      .single();

    expect(userOrg.role).toBe('org_admin');
  });

  test('first organization user should be superuser', async () => {
    // Create first user
    // Verify role === 'superuser'
  });
});
```

### Conclusion

**Status**: âœ… NO ISSUE - WORKING CORRECTLY

**Action Required**: NONE

**Recommendation**: Add integration tests for regression prevention

**Effort**: 0 hours for fixes, 2 hours for tests (optional)

---

<a name="issue-4"></a>
## ðŸŸ¡ ISSUE #4: MISSING DEFAULT WORKFLOW INITIALIZATION [HIGH]

### Issue Summary

**Priority**: ðŸŸ¡ HIGH (P4)
**Component**: Workflow System / Setup Wizard
**Severity**: MEDIUM - Feature incomplete
**Affected Users**: All new organizations
**Status**: âš ï¸ PARTIAL - Schema complete, initialization missing

### Description

The workflow system has a **comprehensive database schema** with all helper functions and API routes fully implemented. However, when a new organization is created during setup, **no default workflow template is created**. This means organizations must manually create workflows before they can use the approval system, creating a poor onboarding experience.

### Steps to Reproduce

1. Complete setup wizard for new organization
2. Upload document successfully
3. Navigate to `/admin/workflows`
4. **OBSERVE**: No workflow templates exist
5. Navigate to `/dashboard`
6. Try to advance a section through approval stages
7. **OBSERVE**: Error - no workflow assigned to document

### Expected Behavior

- Default workflow template created during setup
- Document automatically assigned to default workflow
- All sections initialized in workflow stage 1
- Users can immediately start approval process

### Actual Behavior

- No workflow templates created
- Documents have no workflow assignment
- Sections have no workflow state
- Users must manually create workflows before using system

### Root Cause

**File**: `src/routes/setup.js`
**Function**: `processSetupData()`
**Lines**: 584-656

The setup process creates organization, users, and imports documents, but never initializes the workflow system. The code flow is:

1. âœ… Create organization (Line 610-623)
2. âœ… Create admin user (Line 634-652)
3. âœ… Import document (elsewhere)
4. âŒ **MISSING: Create default workflow**
5. âŒ **MISSING: Assign workflow to document**
6. âŒ **MISSING: Initialize section workflow states**

### Code Analysis

**What Exists** âœ…:

**Database Schema** (Migration 012):
```sql
-- Lines 295-346: Complete schema
CREATE TABLE workflow_templates (
  id UUID PRIMARY KEY,
  organization_id UUID NOT NULL,
  name TEXT NOT NULL,
  description TEXT,
  is_default BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE workflow_stages (
  id UUID PRIMARY KEY,
  workflow_template_id UUID NOT NULL,
  stage_name TEXT NOT NULL,
  stage_order INTEGER NOT NULL,
  can_lock BOOLEAN DEFAULT false,
  can_edit BOOLEAN DEFAULT true,
  can_approve BOOLEAN DEFAULT false,
  requires_approval BOOLEAN DEFAULT false,
  required_roles TEXT[],
  display_color TEXT,
  icon TEXT
);

CREATE TABLE section_workflow_states (
  section_id UUID PRIMARY KEY,
  current_stage_id UUID,
  locked_by UUID,
  locked_at TIMESTAMPTZ,
  state_metadata JSONB
);
```

**Helper Functions** (Migration 012):
- âœ… `is_global_admin()` - Lines 11-22
- âœ… `user_can_approve_stage()` - Lines 27-66
- âœ… `get_section_workflow_stage()` - Lines 71-100
- âœ… `calculate_document_progress()` - Lines 105-135
- âœ… `advance_section_to_next_stage()` - Lines 140-212
- âœ… `lock_section_atomic()` - Lines 724-837

**API Routes** (`src/routes/workflow.js`):
- âœ… Template CRUD: Lines 264-652
- âœ… Stage management: Lines 662-976
- âœ… Section state tracking: Lines 986-1010
- âœ… Approve/reject: Lines 1017-1183

**What's Missing** âŒ:

No initialization code in `processSetupData()` after line 656.

### Impact Assessment

**Severity**: MEDIUM

**User Experience Impact**:
- Setup appears successful but workflow broken
- Users confused why approval system doesn't work
- Additional manual setup required after wizard
- Poor first impression of platform

**Functional Impact**:
- âœ… Documents import successfully
- âœ… Sections display correctly
- âŒ **No approval workflow available**
- âŒ **Cannot advance sections through stages**
- âŒ **Cannot lock sections for editing**

**Workaround**: Users can manually create workflows via `/admin/workflows`, but this is not intuitive.

### Proposed Fix

**File**: `src/routes/setup.js`
**Location**: After line 656 (after organization creation)

```javascript
// Create default workflow template for new organization
try {
  const { data: workflowTemplate, error: workflowError } = await supabase
    .from('workflow_templates')
    .insert({
      organization_id: data.id,
      name: 'Default Approval Workflow',
      description: 'Standard two-stage approval workflow for document sections',
      is_default: true,
      is_active: true
    })
    .select()
    .single();

  if (workflowError) {
    console.error('Failed to create default workflow:', workflowError);
  } else {
    // Create workflow stages
    const { error: stagesError } = await supabase
      .from('workflow_stages')
      .insert([
        {
          workflow_template_id: workflowTemplate.id,
          stage_name: 'Committee Review',
          stage_order: 1,
          can_lock: true,
          can_edit: true,
          can_approve: true,
          requires_approval: true,
          required_roles: ['admin', 'owner'],
          display_color: '#FFD700',
          icon: 'clipboard-check',
          description: 'Initial review by committee members'
        },
        {
          workflow_template_id: workflowTemplate.id,
          stage_name: 'Board Approval',
          stage_order: 2,
          can_lock: false,
          can_edit: false,
          can_approve: true,
          requires_approval: true,
          required_roles: ['owner'],
          display_color: '#90EE90',
          icon: 'check-circle',
          description: 'Final approval by board members'
        }
      ]);

    if (stagesError) {
      console.error('Failed to create workflow stages:', stagesError);
    } else {
      console.log(`Created default workflow ${workflowTemplate.id} for organization ${data.id}`);

      // Store workflow template ID for document assignment
      req.session.setupData.workflowTemplateId = workflowTemplate.id;
    }
  }
} catch (err) {
  console.error('Error creating default workflow:', err);
  // Non-fatal: Continue setup even if workflow creation fails
}
```

**Also Update**: Document import to assign workflow

```javascript
// In document import handler, after sections created
if (req.session.setupData.workflowTemplateId) {
  await supabase
    .from('document_workflows')
    .insert({
      document_id: document.id,
      workflow_template_id: req.session.setupData.workflowTemplateId,
      started_at: new Date().toISOString()
    });

  // Initialize section workflow states
  const firstStage = await supabase
    .from('workflow_stages')
    .select('id')
    .eq('workflow_template_id', req.session.setupData.workflowTemplateId)
    .eq('stage_order', 1)
    .single();

  if (firstStage.data) {
    const sectionIds = sections.map(s => s.id);
    await supabase
      .from('section_workflow_states')
      .insert(
        sectionIds.map(id => ({
          section_id: id,
          current_stage_id: firstStage.data.id,
          state_metadata: { initialized_at: new Date().toISOString() }
        }))
      );
  }
}
```

### Testing Plan

**Unit Tests**:
```javascript
describe('Default Workflow Creation', () => {
  test('should create workflow template during setup', async () => {
    await processSetupData(req, setupData);

    const { data: templates } = await supabase
      .from('workflow_templates')
      .select('*')
      .eq('organization_id', setupData.organization.id);

    expect(templates.length).toBeGreaterThan(0);
    expect(templates[0].is_default).toBe(true);
    expect(templates[0].is_active).toBe(true);
  });

  test('should create workflow stages', async () => {
    await processSetupData(req, setupData);

    const { data: stages } = await supabase
      .from('workflow_stages')
      .select('*')
      .order('stage_order');

    expect(stages.length).toBe(2);
    expect(stages[0].stage_name).toBe('Committee Review');
    expect(stages[1].stage_name).toBe('Board Approval');
  });
});
```

**Integration Tests**:
```javascript
test('complete setup flow with workflow initialization', async () => {
  // 1. Complete setup wizard
  // 2. Verify workflow template created
  // 3. Import document
  // 4. Verify document assigned to workflow
  // 5. Verify sections initialized in stage 1
  // 6. Navigate to dashboard
  // 7. Verify sections show workflow stage
  // 8. Approve section
  // 9. Verify section advances to stage 2
});
```

**Manual QA**:
1. Complete fresh setup
2. Go to `/admin/workflows`
3. Verify "Default Approval Workflow" exists
4. Verify 2 stages configured
5. Go to `/dashboard`
6. Verify sections show "Committee Review" stage
7. Click "Approve" on a section
8. Verify section advances to "Board Approval"

### Estimated Effort

- **Implementation**: 2 hours (setup + document assignment)
- **Unit Tests**: 1 hour
- **Integration Tests**: 1 hour
- **Manual QA**: 30 minutes
- **TOTAL**: 4.5 hours

### Related Issues

- Depends on: None
- Blocks: Workflow system usability
- Related to: Issue #2 (global admin needs workflow access)

### Notes

The workflow system itself is **production-ready** with comprehensive schema, helper functions, and APIs. This issue is purely about **initialization during setup**. The fix is straightforward and non-breaking.

---

<a name="issue-5"></a>
## ðŸ”µ ISSUE #5: 10-LEVEL SUPPORT CONFIGURATION GAP [MEDIUM]

### Issue Summary

**Priority**: ðŸ”µ MEDIUM (P5)
**Component**: Hierarchy Configuration
**Severity**: LOW - Configuration gap only
**Affected Users**: Organizations needing deep hierarchies
**Status**: âœ… INFRASTRUCTURE COMPLETE - Config needs update

### Description

The system **already fully supports 10-level hierarchies** throughout the entire stack (database, parser, storage, UI). However, the default configuration only defines 2 levels (Article, Section) and sets `maxDepth: 5`. This creates a gap between what the system can do and what's configured by default.

### Steps to Reproduce

1. Create organization during setup
2. Try to upload document with 6+ nesting levels
3. **OBSERVE**: Parser stops at level 5
4. **OBSERVE**: Levels beyond 2 show as generic "Level 3", "Level 4"

### Expected Behavior

- System supports 10 levels as documented
- All 10 levels have proper names
- Parser processes full 10-level depth
- UI displays all levels correctly

### Actual Behavior

- System **CAN** support 10 levels but config limits to 5
- Only 2 levels have proper names defined
- Parser respects config limit of 5
- Levels 3-9 unnamed

### Root Cause

**File**: `src/config/organizationConfig.js`
**Lines**: 80-95

**Configuration Gap**:
```javascript
// Current configuration (INCOMPLETE)
const DEFAULT_HIERARCHY_CONFIG = {
  maxDepth: 5,  // âŒ Should be 10
  levels: [
    {
      depth: 0,
      name: 'Article',
      singular: 'Article',
      plural: 'Articles',
      // ... formatting rules
    },
    {
      depth: 1,
      name: 'Section',
      singular: 'Section',
      plural: 'Sections',
      // ... formatting rules
    }
    // âŒ MISSING: depths 2-9
  ]
};
```

### Evidence of Full Support

**Database Schema** âœ…:
```sql
-- database/migrations/001_generalized_schema.sql:187
CHECK (depth >= 0 AND depth <= 10)  -- âœ… Allows 10 levels
```

**Database Trigger** âœ…:
```sql
-- Lines 207-243: update_section_path trigger
-- âœ… No depth restrictions, builds paths automatically
CREATE TRIGGER update_section_path_trigger
BEFORE INSERT OR UPDATE ON document_sections
FOR EACH ROW EXECUTE FUNCTION update_section_path();
```

**Parser** âœ…:
```javascript
// src/parsers/hierarchyDetector.js:251
const maxDepth = hierarchyConfig.maxDepth || 10;  // âœ… Reads from config
```

**Numbering** âœ…:
```javascript
// src/parsers/numberingSchemes.js:175
function formatHierarchical(path) {
  return path.join('.');  // âœ… Handles any depth: 1.2.3.4.5.6.7.8.9.10
}
```

**Storage** âœ…:
```javascript
// src/services/sectionStorage.js:111
// âœ… Stack-based hierarchy building, no depth limits
while (stack.length > 0) {
  const parent = stack[stack.length - 1];
  if (section.depth > parent.depth) {
    parent.children.push(section);
    break;
  }
  stack.pop();
}
```

### Impact Assessment

**Severity**: LOW

**Functional Impact**:
- âœ… System architecture supports 10 levels
- âœ… Database supports 10 levels
- âœ… Parser supports 10 levels
- âœ… Storage supports 10 levels
- âŒ **Config limits to 5 levels**
- âŒ **Only 2 levels have names**

**User Impact**:
- Legal documents with deep structures cannot be imported
- Complex bylaws get truncated
- Subsection numbering stops prematurely

**Workaround**: Organizations can manually edit `hierarchy_config` in database (not user-friendly).

### Proposed Fix

**File**: `src/config/organizationConfig.js`
**Lines**: 80-95

```javascript
const DEFAULT_HIERARCHY_CONFIG = {
  maxDepth: 10,  // âœ… Change from 5 to 10
  levels: [
    {
      depth: 0,
      name: 'Article',
      singular: 'Article',
      plural: 'Articles',
      requiresNumbering: true,
      requiresTitle: true,
      allowsChildren: true
    },
    {
      depth: 1,
      name: 'Section',
      singular: 'Section',
      plural: 'Sections',
      requiresNumbering: true,
      requiresTitle: true,
      allowsChildren: true
    },
    {
      depth: 2,
      name: 'Subsection',
      singular: 'Subsection',
      plural: 'Subsections',
      requiresNumbering: true,
      requiresTitle: true,
      allowsChildren: true
    },
    {
      depth: 3,
      name: 'Paragraph',
      singular: 'Paragraph',
      plural: 'Paragraphs',
      requiresNumbering: true,
      requiresTitle: false,  // Often unnumbered paragraphs
      allowsChildren: true
    },
    {
      depth: 4,
      name: 'Subparagraph',
      singular: 'Subparagraph',
      plural: 'Subparagraphs',
      requiresNumbering: true,
      requiresTitle: false,
      allowsChildren: true
    },
    {
      depth: 5,
      name: 'Clause',
      singular: 'Clause',
      plural: 'Clauses',
      requiresNumbering: true,
      requiresTitle: false,
      allowsChildren: true
    },
    {
      depth: 6,
      name: 'Subclause',
      singular: 'Subclause',
      plural: 'Subclauses',
      requiresNumbering: true,
      requiresTitle: false,
      allowsChildren: true
    },
    {
      depth: 7,
      name: 'Item',
      singular: 'Item',
      plural: 'Items',
      requiresNumbering: true,
      requiresTitle: false,
      allowsChildren: true
    },
    {
      depth: 8,
      name: 'Subitem',
      singular: 'Subitem',
      plural: 'Subitems',
      requiresNumbering: true,
      requiresTitle: false,
      allowsChildren: true
    },
    {
      depth: 9,
      name: 'Point',
      singular: 'Point',
      plural: 'Points',
      requiresNumbering: true,
      requiresTitle: false,
      allowsChildren: false  // Deepest level
    }
  ]
};
```

### Testing Plan

**Unit Tests**:
```javascript
describe('10-Level Hierarchy Support', () => {
  test('should parse document with 10 nesting levels', () => {
    const document = `
      Article I
        Section 1
          Subsection A
            Paragraph 1
              Subparagraph a
                Clause i
                  Subclause Î±
                    Item 1
                      Subitem a
                        Point â€¢
    `;

    const sections = parseDocument(document);
    const deepest = sections.find(s => s.depth === 9);

    expect(deepest).toBeDefined();
    expect(deepest.level_name).toBe('Point');
  });

  test('should format hierarchical numbering for 10 levels', () => {
    const path = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
    const formatted = formatHierarchical(path);

    expect(formatted).toBe('1.2.3.4.5.6.7.8.9.10');
  });
});
```

**Integration Tests**:
```javascript
test('store and retrieve 10-level hierarchy', async () => {
  // 1. Create document with 10 levels
  // 2. Import into database
  // 3. Query sections with depth=9
  // 4. Verify materialized paths correct
  // 5. Verify level_name populated correctly
});
```

**Performance Tests**:
```javascript
test('render 10-level hierarchy in reasonable time', async () => {
  const start = Date.now();

  // Render document with 1000 sections across 10 levels
  await renderHierarchy(documentId);

  const elapsed = Date.now() - start;
  expect(elapsed).toBeLessThan(2000);  // < 2 seconds
});
```

**Manual QA**:
1. Create test document with 10 nesting levels in Word
2. Import via setup wizard
3. Navigate to dashboard
4. Verify all 10 levels display with proper names
5. Verify numbering: 1.2.3.4.5.6.7.8.9.10
6. Test collapsing/expanding each level
7. Verify performance acceptable

### Estimated Effort

- **Implementation**: 30 minutes (configuration only)
- **Unit Tests**: 30 minutes
- **Integration Tests**: 30 minutes
- **Performance Tests**: 30 minutes
- **Manual QA**: 1 hour
- **TOTAL**: 2.5 hours

### Related Issues

- Depends on: Issue #1 (hierarchy config must be saved)
- Blocks: Complex document imports
- Related to: None

### Notes

This is the **easiest fix** of all priorities - purely a configuration update with zero code changes. The system already fully supports 10 levels everywhere. The risk is minimal because:

1. âœ… Backward compatible (existing 2-level orgs unaffected)
2. âœ… Database already validates depth <= 10
3. âœ… Parser already respects maxDepth from config
4. âœ… All code paths already handle arbitrary depth

The only question is whether the **level names** chosen are appropriate for legal documents. Consider making these customizable per organization.

---

<a name="issue-6"></a>
## ðŸ”µ ISSUE #6: SECTION EDITING OPERATIONS MISSING [MEDIUM]

### Issue Summary

**Priority**: ðŸ”µ MEDIUM (P6)
**Component**: Admin Features / Section Management
**Severity**: MEDIUM - Feature never implemented
**Affected Users**: Organization administrators
**Status**: âš ï¸ MISSING - Infrastructure exists, CRUD operations needed

### Description

Organization administrators should be able to manually edit document sections (split, join, retitle, move, delete) to correct parsing errors or reorganize content. The admin infrastructure exists (`src/routes/admin.js`, role-based auth, organization management) but **section-level CRUD operations were never implemented**.

### User Story

**As an** organization administrator
**I want to** manually edit document sections
**So that** I can correct parsing mistakes and reorganize content without re-importing

### Use Cases

1. **Split Section**: Parser missed a section break, admin manually splits one section into two
2. **Join Sections**: Parser created extra section break, admin joins two sections
3. **Retitle Section**: Parsed title is incorrect, admin fixes the title
4. **Move Section**: Section is under wrong parent, admin moves to correct location
5. **Delete Section**: Duplicate or invalid section, admin removes it

### Steps to Reproduce Current Behavior

1. Login as organization admin
2. Navigate to `/admin/sections`
3. **OBSERVE**: 404 - Route doesn't exist
4. Try to edit section from dashboard
5. **OBSERVE**: No edit button available
6. Check database directly to edit
7. **REALIZE**: Must use SQL to make changes

### Expected Behavior

- Admin panel at `/admin/sections` showing document tree
- Inline editing for section titles
- Context menu for operations: Split, Join, Move, Delete
- Drag-and-drop reordering
- Confirmation dialogs for destructive operations
- Workflow lock validation (can't edit locked sections)
- Audit trail of all changes

### Actual Behavior

- No section editing UI exists
- No API routes for section operations
- Database helpers missing
- Only option: Direct SQL manipulation (dangerous)

### What Exists âœ…

**Admin Infrastructure**:
- âœ… `src/routes/admin.js` - Admin routes framework
- âœ… `src/middleware/roleAuth.js` - Permission checking
- âœ… `requireOrgAdmin` middleware exists
- âœ… Organization management routes
- âœ… Workflow template management
- âœ… User management

**Database Schema**:
- âœ… `document_sections` table with materialized paths
- âœ… `update_section_path()` trigger for automatic path maintenance
- âœ… Foreign key constraints
- âœ… Audit columns (created_at, updated_at)

### What's Missing âŒ

**1. Database Helper Functions**:
```sql
-- database/migrations/013_section_admin_helpers.sql
CREATE OR REPLACE FUNCTION increment_sibling_ordinals(
  p_parent_id UUID,
  p_from_ordinal INTEGER
) RETURNS VOID;

CREATE OR REPLACE FUNCTION decrement_sibling_ordinals(
  p_parent_id UUID,
  p_from_ordinal INTEGER
) RETURNS VOID;

CREATE OR REPLACE FUNCTION renumber_document_sections(
  p_document_id UUID
) RETURNS VOID;

CREATE OR REPLACE FUNCTION split_section(
  p_section_id UUID,
  p_split_point INTEGER
) RETURNS UUID;  -- Returns new section ID

CREATE OR REPLACE FUNCTION join_sections(
  p_first_section_id UUID,
  p_second_section_id UUID
) RETURNS UUID;  -- Returns merged section ID
```

**2. API Routes** (`src/routes/admin.js`):
```javascript
// Split section into two sections
POST /admin/sections/:id/split
Body: { splitPoint: 500 }  // Character position to split at

// Join two adjacent sections
POST /admin/sections/:id/join
Body: { withSectionId: 'uuid' }

// Retitle section
PUT /admin/sections/:id/retitle
Body: { newTitle: 'Updated Title' }

// Move section to different parent
PUT /admin/sections/:id/move
Body: { newParentId: 'uuid', newOrdinal: 3 }

// Delete section (and optionally children)
DELETE /admin/sections/:id
Query: ?deleteChildren=true
```

**3. Admin UI Components**:
```javascript
// views/admin/section-editor.ejs
- Section tree view (collapsible)
- Inline title editing
- Context menu for operations
- Drag-and-drop reordering
- Confirmation dialogs
- Workflow lock indicators
```

### Impact Assessment

**Severity**: MEDIUM

**Functional Impact**:
- âœ… Documents can be imported
- âœ… Sections display correctly
- âŒ **Cannot correct parsing errors**
- âŒ **Cannot reorganize structure**
- âŒ **Manual database edits required** (risky)

**User Impact**:
- Administrators frustrated when parser makes mistakes
- Time wasted re-importing entire document
- Risk of data corruption from manual SQL edits
- Poor perception of platform quality

**Workaround**: Direct SQL manipulation (requires database access, risky, no audit trail)

### Implementation Requirements

#### Phase 1: Database Helpers (2 days)

**File**: `database/migrations/013_section_admin_helpers.sql`

```sql
-- Helper: Increment ordinals for siblings after insert/move
CREATE OR REPLACE FUNCTION increment_sibling_ordinals(
  p_parent_id UUID,
  p_from_ordinal INTEGER
) RETURNS VOID AS $$
BEGIN
  UPDATE document_sections
  SET ordinal_position = ordinal_position + 1
  WHERE parent_id IS NOT DISTINCT FROM p_parent_id
    AND ordinal_position >= p_from_ordinal;
END;
$$ LANGUAGE plpgsql;

-- Helper: Decrement ordinals for siblings after delete
CREATE OR REPLACE FUNCTION decrement_sibling_ordinals(
  p_parent_id UUID,
  p_from_ordinal INTEGER
) RETURNS VOID AS $$
BEGIN
  UPDATE document_sections
  SET ordinal_position = ordinal_position - 1
  WHERE parent_id IS NOT DISTINCT FROM p_parent_id
    AND ordinal_position > p_from_ordinal;
END;
$$ LANGUAGE plpgsql;

-- Helper: Renumber entire document's ordinals
CREATE OR REPLACE FUNCTION renumber_document_sections(
  p_document_id UUID
) RETURNS VOID AS $$
DECLARE
  v_section RECORD;
  v_ordinal INTEGER;
BEGIN
  -- Renumber sections depth by depth
  FOR v_depth IN 0..10 LOOP
    v_ordinal := 0;

    FOR v_section IN
      SELECT id, parent_id
      FROM document_sections
      WHERE document_id = p_document_id
        AND depth = v_depth
      ORDER BY parent_id NULLS FIRST, ordinal_position
    LOOP
      UPDATE document_sections
      SET ordinal_position = v_ordinal
      WHERE id = v_section.id;

      v_ordinal := v_ordinal + 1;
    END LOOP;
  END LOOP;
END;
$$ LANGUAGE plpgsql;
```

#### Phase 2: API Routes (2 days)

**File**: `src/routes/admin.js`

```javascript
// Split section
router.post('/sections/:id/split', requireOrgAdmin, async (req, res) => {
  try {
    const { id } = req.params;
    const { splitPoint } = req.body;

    // 1. Validate section exists and belongs to user's org
    const { data: section } = await supabase
      .from('document_sections')
      .select('*, document:documents(organization_id)')
      .eq('id', id)
      .single();

    if (section.document.organization_id !== req.user.organization_id) {
      return res.status(403).json({ error: 'Not authorized' });
    }

    // 2. Check if section is locked by workflow
    const { data: workflowState } = await supabase
      .from('section_workflow_states')
      .select('locked_by')
      .eq('section_id', id)
      .single();

    if (workflowState?.locked_by) {
      return res.status(400).json({
        error: 'Section is locked by workflow'
      });
    }

    // 3. Split content
    const content1 = section.content.substring(0, splitPoint);
    const content2 = section.content.substring(splitPoint);

    // 4. Update original section
    await supabase
      .from('document_sections')
      .update({ content: content1 })
      .eq('id', id);

    // 5. Create new section
    const { data: newSection } = await supabase
      .from('document_sections')
      .insert({
        document_id: section.document_id,
        parent_id: section.parent_id,
        depth: section.depth,
        ordinal_position: section.ordinal_position + 1,
        level_name: section.level_name,
        title: section.title + ' (continued)',
        content: content2,
        organization_id: section.organization_id
      })
      .select()
      .single();

    // 6. Increment ordinals for subsequent siblings
    await supabase.rpc('increment_sibling_ordinals', {
      p_parent_id: section.parent_id,
      p_from_ordinal: section.ordinal_position + 2
    });

    // 7. Trigger path recalculation (automatic via trigger)

    res.json({
      originalSection: section,
      newSection: newSection
    });
  } catch (error) {
    console.error('Split section error:', error);
    res.status(500).json({ error: 'Failed to split section' });
  }
});

// Join sections
router.post('/sections/:id/join', requireOrgAdmin, async (req, res) => {
  // Similar validation and implementation
});

// Retitle section
router.put('/sections/:id/retitle', requireOrgAdmin, async (req, res) => {
  // Validate, check workflow lock, update title
});

// Move section
router.put('/sections/:id/move', requireOrgAdmin, async (req, res) => {
  // Validate, check workflow lock, update parent_id/ordinal,
  // recalculate paths for entire subtree
});

// Delete section
router.delete('/sections/:id', requireOrgAdmin, async (req, res) => {
  // Validate, check workflow lock, confirm if has children,
  // cascade delete or prevent, update ordinals
});
```

#### Phase 3: Admin UI (3 days)

**File**: `views/admin/section-editor.ejs`

```html
<div class="section-editor">
  <!-- Document selector -->
  <select id="document-select">
    <% documents.forEach(doc => { %>
      <option value="<%= doc.id %>"><%= doc.title %></option>
    <% }) %>
  </select>

  <!-- Section tree -->
  <div id="section-tree" class="tree-view">
    <!-- Recursively render sections -->
    <%- include('partials/section-tree-node', { sections: sections }) %>
  </div>

  <!-- Context menu -->
  <div id="context-menu" class="hidden">
    <button data-action="retitle">Retitle</button>
    <button data-action="split">Split</button>
    <button data-action="join">Join</button>
    <button data-action="move">Move</button>
    <button data-action="delete">Delete</button>
  </div>

  <!-- Confirmation dialog -->
  <dialog id="confirm-dialog">
    <h3 id="confirm-title"></h3>
    <p id="confirm-message"></p>
    <button id="confirm-yes">Yes</button>
    <button id="confirm-no">No</button>
  </dialog>
</div>

<script src="/js/section-editor.js"></script>
```

**File**: `public/js/section-editor.js`

```javascript
// Initialize drag-and-drop
const tree = document.getElementById('section-tree');
new Sortable(tree, {
  animation: 150,
  ghostClass: 'sortable-ghost',
  onEnd: async (evt) => {
    const sectionId = evt.item.dataset.id;
    const newParentId = evt.to.dataset.parentId;
    const newOrdinal = evt.newIndex;

    await moveSection(sectionId, newParentId, newOrdinal);
  }
});

// Context menu handlers
document.addEventListener('contextmenu', (e) => {
  if (e.target.closest('.section-node')) {
    e.preventDefault();
    showContextMenu(e.pageX, e.pageY, e.target.closest('.section-node'));
  }
});

async function splitSection(sectionId) {
  const splitPoint = await promptForSplitPoint();
  const response = await fetch(`/admin/sections/${sectionId}/split`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ splitPoint })
  });

  if (response.ok) {
    reloadSectionTree();
  }
}
```

### Risk Assessment & Mitigation

| Risk | Impact | Probability | Mitigation |
|------|--------|------------|------------|
| Data corruption | HIGH | MEDIUM | Use database transactions |
| Orphaned suggestions | MEDIUM | HIGH | Cascade delete or reassign |
| Workflow lock bypass | HIGH | LOW | Validate before all operations |
| Concurrent edits | MEDIUM | MEDIUM | Row-level locking |
| Lost children | HIGH | LOW | Confirm before deleting parents |
| Path recalculation | MEDIUM | MEDIUM | Use database trigger |

**Mitigation Strategies**:

1. **Transactions**: Wrap all operations in transactions
2. **Validation**: Check workflow state before every edit
3. **Confirmation**: Require confirmation for destructive operations
4. **Audit Trail**: Log all section edits
5. **Undo Support**: Store section history for rollback
6. **Testing**: Comprehensive integration tests

### Testing Plan

**Unit Tests** (Database Helpers):
```javascript
describe('Section Admin Helpers', () => {
  test('increment_sibling_ordinals updates correct sections', async () => {
    // Create 5 sections with ordinals 0-4
    // Call increment_sibling_ordinals(parent_id, 2)
    // Verify sections 2,3,4 now have ordinals 3,4,5
  });

  test('renumber_document_sections fixes gaps', async () => {
    // Create sections with ordinals 0,1,5,7
    // Call renumber_document_sections
    // Verify ordinals now 0,1,2,3
  });
});
```

**Integration Tests** (API Routes):
```javascript
describe('Section Admin API', () => {
  test('split section creates new section and updates ordinals', async () => {
    // Create section with 1000 chars
    // POST /admin/sections/:id/split { splitPoint: 500 }
    // Verify two sections exist
    // Verify content split correctly
    // Verify ordinals updated
  });

  test('cannot edit locked section', async () => {
    // Lock section via workflow
    // Try to retitle
    // Expect 400 error
  });

  test('delete section with children requires confirmation', async () => {
    // Create parent with 3 children
    // DELETE /admin/sections/:id
    // Expect 400 with warning
    // DELETE with ?deleteChildren=true
    // Verify cascade delete
  });
});
```

**E2E Tests**:
```javascript
test('admin can reorganize document structure', async () => {
  // 1. Login as org admin
  // 2. Navigate to /admin/sections
  // 3. Select document
  // 4. Right-click section
  // 5. Click "Split"
  // 6. Enter split point
  // 7. Confirm
  // 8. Verify tree updates
  // 9. Refresh page
  // 10. Verify changes persisted
});
```

### Estimated Effort

**Phase 1: Database Helpers**
- SQL functions: 4 hours
- Unit tests: 4 hours
- **Subtotal**: 1 day

**Phase 2: API Routes**
- Route implementation: 8 hours
- Validation logic: 4 hours
- Integration tests: 4 hours
- **Subtotal**: 2 days

**Phase 3: Admin UI**
- Component development: 12 hours
- Drag-and-drop: 4 hours
- E2E tests: 4 hours
- **Subtotal**: 2.5 days

**Phase 4: Security Hardening**
- Workflow lock validation: 2 hours
- Permission checks: 2 hours
- Security tests: 4 hours
- **Subtotal**: 1 day

**TOTAL**: 6.5 days (round up to 1 week)

### Prioritization Rationale

**Why MEDIUM priority?**
- Not blocking core functionality (documents can be imported)
- Affects only admins fixing parsing errors
- Workaround exists (re-import document)
- Can be deferred to post-launch sprint

**Why not LOW?**
- Parsing errors are common with Word documents
- Manual SQL edits are risky
- Good admin UX important for platform adoption

### Related Issues

- Depends on: None
- Blocks: None (nice-to-have feature)
- Related to: Issue #5 (10-level support increases need for editing)

### Notes

This is a **complete feature implementation**, not a bug fix. The scope is large (1 week) and the feature is not critical for launch. Consider:

1. **MVP Approach**: Start with just "Retitle" and "Delete" operations
2. **Phase 2**: Add "Split" and "Join" later
3. **Phase 3**: Add "Move" with drag-and-drop last

This would reduce initial effort to 3 days while still providing value.

---

## ðŸ“‹ SUMMARY

Total issues identified: **6**

**Critical** (Block Production): 2
- âœ… Issue #1: Save hierarchy config
- âœ… Issue #2: Fix global admin RLS

**High** (Ship Within 1 Week): 2
- âœ… Issue #3: No issue (working correctly)
- âœ… Issue #4: Initialize default workflows

**Medium** (Next Sprint): 2
- âœ… Issue #5: Update 10-level config
- âœ… Issue #6: Implement section editing

**Total Fix Effort**: 18.5 hours + 1 week for P6

---

*Generated by Hive Mind Code Review Swarm*
*Date: 2025-10-14*
