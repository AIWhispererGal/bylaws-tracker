# Environment Variables Setup Guide

## Required Environment Variables

### Core Application Settings

#### `NODE_ENV`
- **Description**: Application environment mode
- **Required**: Yes
- **Default**: `development`
- **Production Value**: `production`
- **Purpose**:
  - Controls secure cookie settings
  - Enables production optimizations
  - Affects error handling verbosity

```bash
NODE_ENV=production
```

#### `PORT`
- **Description**: Port number for the Express server
- **Required**: No (auto-assigned by Render)
- **Default**: `3000` (development), `10000` (Render)
- **Render**: Automatically set by platform
- **Purpose**: Defines which port the server listens on

```bash
PORT=10000
```

---

### Database Configuration (Supabase)

#### `SUPABASE_URL`
- **Description**: Your Supabase project URL
- **Required**: Yes
- **Format**: `https://xxxxxxxxxxxxx.supabase.co`
- **How to Get**:
  1. Go to https://supabase.com
  2. Open your project
  3. Navigate to Settings → API
  4. Copy "Project URL"

```bash
SUPABASE_URL=https://your-project-id.supabase.co
```

#### `SUPABASE_ANON_KEY`
- **Description**: Supabase anonymous/public API key
- **Required**: Yes
- **Format**: Long alphanumeric string starting with `eyJ...`
- **Security**: This is the public key (safe to expose client-side)
- **How to Get**:
  1. Go to https://supabase.com
  2. Open your project
  3. Navigate to Settings → API
  4. Copy "anon public" key

```bash
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

⚠️ **Important**: Do NOT use the `service_role` key in client-facing applications. Use only the `anon` key.

---

### Session & Security

#### `SESSION_SECRET`
- **Description**: Secret key for encrypting session data
- **Required**: Yes
- **Security**: Must be random and unique
- **How to Generate**:
  ```bash
  # Option 1: OpenSSL (recommended)
  openssl rand -hex 32

  # Option 2: Node.js
  node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

  # Option 3: Use Render's auto-generate feature
  ```
- **Render**: Can be auto-generated using "Generate Value" option

```bash
SESSION_SECRET=a1b2c3d4e5f6...64-character-hex-string
```

⚠️ **Critical**:
- Never commit this to Git
- Change this if compromised
- Use different values for dev/staging/production

---

### Application URLs

#### `APP_URL`
- **Description**: Public URL of your deployed application
- **Required**: No (has default)
- **Default**: `http://localhost:3000`
- **Production Value**: Your Render app URL
- **Format**: `https://your-app-name.onrender.com`
- **Purpose**:
  - Used for generating absolute URLs
  - CORS configuration
  - Email links (future feature)

```bash
# Development
APP_URL=http://localhost:3000

# Production (Render auto-assigns)
APP_URL=https://bylaws-tracker.onrender.com
```

---

### Setup Wizard Configuration

#### `SETUP_MODE`
- **Description**: Controls setup wizard availability
- **Required**: No
- **Default**: `enabled`
- **Values**: `enabled` | `disabled`
- **Purpose**:
  - Enable setup wizard on first deployment
  - Disable after initial configuration (optional)

```bash
SETUP_MODE=enabled
```

---

### Optional/Legacy Configuration

#### `GOOGLE_DOC_ID`
- **Description**: Google Docs integration (legacy feature)
- **Required**: No
- **Format**: Document ID from Google Docs URL
- **Purpose**: Import bylaws from Google Docs
- **Status**: Optional, primarily for backward compatibility

```bash
GOOGLE_DOC_ID=1abc...xyz
```

---

## Environment Setup by Platform

### Development (Local)

Create `.env` file in project root:

```bash
# .env (local development)
NODE_ENV=development
PORT=3000
APP_URL=http://localhost:3000

# Supabase (use test project)
SUPABASE_URL=https://your-dev-project.supabase.co
SUPABASE_ANON_KEY=your-dev-anon-key

# Security (use simple secret for dev)
SESSION_SECRET=dev-secret-change-in-production

# Setup
SETUP_MODE=enabled

# Optional
GOOGLE_DOC_ID=
```

⚠️ **Remember**:
- Copy from `.env.example`
- Never commit `.env` to Git
- Use separate Supabase project for development

---

### Render Production

Set environment variables in Render Dashboard:

1. **Navigate to**: Dashboard → Your Service → Environment
2. **Click**: "Add Environment Variable"
3. **Add each variable**:

```bash
# Required - Set these manually
NODE_ENV=production
SUPABASE_URL=https://your-prod-project.supabase.co
SUPABASE_ANON_KEY=your-prod-anon-key

# Auto-generated by Render
PORT=10000              # Auto-set, don't override
SESSION_SECRET=...      # Click "Generate Value"

# Set by Render or configure
APP_URL=https://your-app.onrender.com

# Optional
SETUP_MODE=enabled
GOOGLE_DOC_ID=
```

**Render Environment Variable Options**:
- ✅ **Generate Value**: Use for SESSION_SECRET (creates secure random string)
- ✅ **Sync**: Link multiple services (not needed for this app)
- ⚠️ **Not Sync**: Mark sensitive values (SUPABASE_ANON_KEY, etc.)

---

### Using render.yaml (Blueprint)

The `render.yaml` file defines environment variables for one-click deploy:

```yaml
envVars:
  # Auto-configured
  - key: NODE_ENV
    value: production

  - key: PORT
    value: 10000

  # Auto-generated
  - key: SESSION_SECRET
    generateValue: true

  # User must configure during deploy
  - key: SUPABASE_URL
    sync: false

  - key: SUPABASE_ANON_KEY
    sync: false

  # Optional defaults
  - key: SETUP_MODE
    value: enabled
```

**One-Click Deploy**:
1. Click "Deploy to Render" button
2. Fill in required values:
   - SUPABASE_URL
   - SUPABASE_ANON_KEY
3. Click "Apply"

---

## Security Best Practices

### 1. Secret Management

✅ **DO**:
- Use Render's "Generate Value" for secrets
- Use different secrets for dev/staging/prod
- Rotate secrets periodically
- Use environment variables, not config files
- Set sensitive vars to "Not Sync" in Render

❌ **DON'T**:
- Commit `.env` to Git (add to `.gitignore`)
- Share secrets in chat/email
- Use same secrets across environments
- Hardcode secrets in code
- Use weak or predictable secrets

### 2. Supabase Keys

```bash
# ✅ CORRECT: Use anon key (public)
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# ❌ WRONG: Never use service_role key client-side
# SUPABASE_SERVICE_KEY=eyJ... (DO NOT USE)
```

**Why**:
- `anon` key: Safe for client-side, respects Row Level Security (RLS)
- `service_role` key: Bypasses RLS, full admin access, backend only

### 3. Session Security

```bash
# Strong session secret (64 characters)
SESSION_SECRET=$(openssl rand -hex 32)
```

**Session Configuration** (in `server.js`):
```javascript
session({
  secret: SESSION_SECRET,
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: process.env.NODE_ENV === 'production', // HTTPS only
    httpOnly: true,                                // No JS access
    maxAge: 24 * 60 * 60 * 1000                   // 24 hours
  }
})
```

---

## Validation & Testing

### Check Environment Variables

Create a test endpoint (remove in production):

```javascript
// Add to server.js (temporary)
app.get('/api/check-env', (req, res) => {
  res.json({
    NODE_ENV: process.env.NODE_ENV,
    PORT: process.env.PORT,
    APP_URL: process.env.APP_URL,
    SUPABASE_CONFIGURED: !!process.env.SUPABASE_URL,
    SESSION_CONFIGURED: !!process.env.SESSION_SECRET,
    // Never expose actual values!
  });
});
```

### Health Check Validation

The existing `/api/health` endpoint validates database connection:

```bash
curl https://your-app.onrender.com/api/health
```

Expected response:
```json
{
  "status": "healthy",
  "database": "connected",
  "timestamp": "2025-10-09T12:34:56.789Z"
}
```

If `database: "disconnected"`:
- ❌ SUPABASE_URL is incorrect
- ❌ SUPABASE_ANON_KEY is invalid
- ❌ Supabase project is paused/deleted
- ❌ Network connectivity issue

---

## Migration from .env to Render

### Step-by-Step Migration

1. **Backup Local .env**:
   ```bash
   cp .env .env.backup
   ```

2. **List Current Variables**:
   ```bash
   cat .env | grep -v '^#' | grep -v '^$'
   ```

3. **Create Supabase Production Project**:
   - Sign up at https://supabase.com
   - Create new project
   - Copy production URL and anon key
   - Run production migrations

4. **Set Render Variables**:
   - Go to Render Dashboard
   - Add each variable from local .env
   - Use production Supabase credentials
   - Generate new SESSION_SECRET

5. **Deploy & Test**:
   - Deploy application
   - Test /api/health endpoint
   - Verify setup wizard works
   - Check logs for errors

---

## Troubleshooting

### Issue: Database connection fails

**Symptoms**:
- Health check returns `database: "disconnected"`
- Errors in logs: `Failed to fetch` or `Invalid API key`

**Solutions**:
1. Verify SUPABASE_URL format:
   - Must start with `https://`
   - Must end with `.supabase.co`
   - Example: `https://abcdefgh.supabase.co`

2. Verify SUPABASE_ANON_KEY:
   - Must be the full JWT token
   - Starts with `eyJ`
   - No extra spaces or line breaks

3. Check Supabase project status:
   - Project is not paused
   - No billing issues
   - API is enabled

### Issue: Session not persisting

**Symptoms**:
- Users logged out on refresh
- "Session expired" errors

**Solutions**:
1. Check SESSION_SECRET is set:
   ```bash
   echo $SESSION_SECRET  # Should return value
   ```

2. Verify cookie settings:
   - `secure: true` only in production (HTTPS)
   - `httpOnly: true` for security

3. Check Render logs for session errors

### Issue: Setup wizard not appearing

**Symptoms**:
- Redirects to /bylaws instead of /setup
- "Organization already configured" error

**Solutions**:
1. Check SETUP_MODE:
   ```bash
   SETUP_MODE=enabled
   ```

2. Clear session:
   - Delete cookies in browser
   - Or clear database organizations table (dev only)

3. Verify database is empty:
   - Run: `SELECT * FROM organizations LIMIT 1;`
   - Should return 0 rows on first deploy

---

## Environment Variable Checklist

Use this checklist when deploying:

### Pre-Deployment
- [ ] Created production Supabase project
- [ ] Copied SUPABASE_URL from dashboard
- [ ] Copied SUPABASE_ANON_KEY (not service_role!)
- [ ] Generated strong SESSION_SECRET (32+ bytes)
- [ ] Noted APP_URL (or will update after deploy)

### During Deployment
- [ ] Set NODE_ENV=production
- [ ] Set PORT=10000 (or leave for Render)
- [ ] Set SUPABASE_URL
- [ ] Set SUPABASE_ANON_KEY
- [ ] Generated or set SESSION_SECRET
- [ ] Set SETUP_MODE=enabled (first deploy)

### Post-Deployment
- [ ] Updated APP_URL if needed
- [ ] Tested /api/health endpoint
- [ ] Completed setup wizard
- [ ] Verified database connection
- [ ] Checked application logs

---

## Quick Reference

### Production .env Template

```bash
# Copy to Render environment variables
NODE_ENV=production
PORT=10000
APP_URL=https://your-app.onrender.com
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJI...
SESSION_SECRET=$(openssl rand -hex 32)
SETUP_MODE=enabled
```

### Generate Session Secret

```bash
# macOS/Linux
openssl rand -hex 32

# Windows (PowerShell)
[Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Maximum 256 }))

# Node.js (any platform)
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### Verify Supabase Connection

```bash
# Using curl
curl -X GET https://your-project.supabase.co/rest/v1/organizations \
  -H "apikey: YOUR_ANON_KEY" \
  -H "Authorization: Bearer YOUR_ANON_KEY"

# Should return JSON (even if empty array)
```

---

**Last Updated**: October 9, 2025
**Version**: 1.0.0
