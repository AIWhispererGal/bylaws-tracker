<!-- Document Upload Modal -->
<!-- ADD THIS MODAL BEFORE THE CLOSING </div> and SCRIPT TAGS IN dashboard.ejs -->

<div class="modal fade" id="uploadDocumentModal" tabindex="-1" aria-labelledby="uploadDocumentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uploadDocumentModalLabel">
          <i class="bi bi-file-earmark-arrow-up"></i> Upload New Document
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="uploadDocumentForm" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="documentFile" class="form-label">Document File (.docx)</label>
            <input type="file" class="form-control" id="documentFile" name="document" accept=".doc,.docx" required>
            <div class="form-text">Maximum file size: 10MB. Only Word documents (.doc, .docx) are supported.</div>
          </div>

          <!-- Progress Bar (hidden by default) -->
          <div id="uploadProgress" class="mb-3" style="display: none;">
            <div class="progress">
              <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
            </div>
            <div id="uploadStatus" class="text-center mt-2 text-muted">Uploading...</div>
          </div>

          <!-- Error Display -->
          <div id="uploadError" class="alert alert-danger" style="display: none;"></div>

          <!-- Success Display -->
          <div id="uploadSuccess" class="alert alert-success" style="display: none;"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="uploadDocumentBtn">
          <i class="bi bi-cloud-upload"></i> Upload Document
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Document Upload Handler
document.getElementById('uploadDocumentBtn').addEventListener('click', function() {
  const form = document.getElementById('uploadDocumentForm');
  const fileInput = document.getElementById('documentFile');
  const progressDiv = document.getElementById('uploadProgress');
  const progressBar = document.getElementById('uploadProgressBar');
  const statusDiv = document.getElementById('uploadStatus');
  const errorDiv = document.getElementById('uploadError');
  const successDiv = document.getElementById('uploadSuccess');
  const uploadBtn = this;

  // Validate file selected
  if (!fileInput.files || fileInput.files.length === 0) {
    errorDiv.textContent = 'Please select a file to upload';
    errorDiv.style.display = 'block';
    return;
  }

  // Validate file type
  const file = fileInput.files[0];
  const validTypes = ['application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/msword'];
  if (!validTypes.includes(file.type)) {
    errorDiv.textContent = 'Invalid file type. Please upload a Word document (.doc or .docx)';
    errorDiv.style.display = 'block';
    return;
  }

  // Validate file size (10MB)
  if (file.size > 10 * 1024 * 1024) {
    errorDiv.textContent = 'File size exceeds 10MB limit';
    errorDiv.style.display = 'block';
    return;
  }

  // Reset UI
  errorDiv.style.display = 'none';
  successDiv.style.display = 'none';
  progressDiv.style.display = 'block';
  uploadBtn.disabled = true;

  // Create FormData
  const formData = new FormData();
  formData.append('document', file);

  // Upload with progress tracking
  const xhr = new XMLHttpRequest();

  xhr.upload.addEventListener('progress', function(e) {
    if (e.lengthComputable) {
      const percentComplete = (e.loaded / e.total) * 100;
      progressBar.style.width = percentComplete + '%';
      statusDiv.textContent = `Uploading... ${Math.round(percentComplete)}%`;
    }
  });

  xhr.addEventListener('load', function() {
    if (xhr.status === 200) {
      try {
        const response = JSON.parse(xhr.responseText);
        if (response.success) {
          progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
          progressBar.classList.add('bg-success');
          progressBar.style.width = '100%';
          statusDiv.textContent = 'Upload complete! Processing document...';

          // Show success message
          let successMessage = `Document "${response.document.title}" uploaded successfully with ${response.document.sectionsCount} sections.`;
          if (response.warnings && response.warnings.length > 0) {
            successMessage += '\n\nWarnings:\n' + response.warnings.join('\n');
          }
          successDiv.textContent = successMessage;
          successDiv.style.display = 'block';

          // Hide progress after 2 seconds and reload page
          setTimeout(() => {
            location.reload();
          }, 2000);
        } else {
          throw new Error(response.error || 'Upload failed');
        }
      } catch (e) {
        errorDiv.textContent = 'Error: ' + e.message;
        errorDiv.style.display = 'block';
        progressDiv.style.display = 'none';
        uploadBtn.disabled = false;
      }
    } else {
      let errorMessage = 'Upload failed';
      try {
        const response = JSON.parse(xhr.responseText);
        errorMessage = response.error || errorMessage;
        if (response.validationErrors && response.validationErrors.length > 0) {
          errorMessage += '\n\nValidation Errors:\n' + response.validationErrors.map(e => e.message).join('\n');
        }
      } catch (e) {
        errorMessage = `Server error: ${xhr.status}`;
      }
      errorDiv.textContent = errorMessage;
      errorDiv.style.display = 'block';
      progressDiv.style.display = 'none';
      uploadBtn.disabled = false;
    }
  });

  xhr.addEventListener('error', function() {
    errorDiv.textContent = 'Network error occurred during upload';
    errorDiv.style.display = 'block';
    progressDiv.style.display = 'none';
    uploadBtn.disabled = false;
  });

  xhr.open('POST', '/admin/documents/upload');
  xhr.send(formData);
});

// Reset modal when closed
document.getElementById('uploadDocumentModal').addEventListener('hidden.bs.modal', function() {
  document.getElementById('uploadDocumentForm').reset();
  document.getElementById('uploadProgress').style.display = 'none';
  document.getElementById('uploadError').style.display = 'none';
  document.getElementById('uploadSuccess').style.display = 'none';
  document.getElementById('uploadDocumentBtn').disabled = false;
});
</script>

<!-- UPDATE THE QUICK ACTIONS SECTION TO ADD THIS BUTTON -->
<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadDocumentModal">
  <i class="bi bi-file-earmark-arrow-up"></i> Upload Document
</button>
