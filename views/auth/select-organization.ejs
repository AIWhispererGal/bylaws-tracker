<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Bylaws Amendment Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .select-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 3rem;
      max-width: 800px;
      width: 100%;
      margin: 2rem;
    }

    .header-section {
      text-align: center;
      margin-bottom: 2.5rem;
    }

    .header-section h1 {
      color: #667eea;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .header-section p {
      color: #6c757d;
      font-size: 1.1rem;
    }

    .org-card {
      border: 2px solid #e9ecef;
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .org-card:hover {
      border-color: #667eea;
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
    }

    .org-card.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
    }

    .org-card h3 {
      margin: 0 0 0.5rem 0;
      color: #333;
      font-size: 1.4rem;
      font-weight: 600;
    }

    .org-card .meta {
      color: #6c757d;
      font-size: 0.9rem;
    }

    .org-card .badge {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
    }

    .btn-select {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      color: white;
      font-weight: 600;
      padding: 0.75rem 2rem;
      border-radius: 10px;
      transition: all 0.3s ease;
      margin-top: 0.75rem;
    }

    .btn-select:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-outline-secondary {
      border-color: #6c757d;
      color: #6c757d;
    }

    .btn-outline-secondary:hover {
      background-color: #6c757d;
      color: white;
    }

    .admin-controls {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 1.5rem;
      margin-top: 2rem;
      text-align: center;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #6c757d;
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .stats-badge {
      display: inline-block;
      background: #e7f3ff;
      color: #0066cc;
      padding: 0.25rem 0.75rem;
      border-radius: 15px;
      font-size: 0.85rem;
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="select-container">
    <div class="header-section">
      <h1><i class="bi bi-building"></i> Select Organization</h1>
      <p>Choose an organization to access its dashboard</p>

      <!-- Role/Admin Badges -->
      <div class="d-flex justify-content-center gap-2 mt-2">
        <% if (isAdmin) { %>
          <span class="badge bg-danger" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
            <i class="bi bi-shield-fill-check"></i> Global Admin Mode
          </span>
        <% } %>

        <% if (typeof user !== 'undefined' && user && !isAdmin) { %>
          <% if (user.role === 'owner') { %>
            <span class="badge bg-warning text-dark" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
              <i class="bi bi-star-fill"></i> Organization Owner
            </span>
          <% } else if (user.role === 'admin') { %>
            <span class="badge bg-warning text-dark" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
              <i class="bi bi-star-fill"></i> Organization Admin
            </span>
          <% } else if (user.role === 'member') { %>
            <span class="badge bg-success" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
              <i class="bi bi-person-check"></i> Member
            </span>
          <% } else if (user.role === 'viewer') { %>
            <span class="badge bg-info" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
              <i class="bi bi-eye"></i> Viewer
            </span>
          <% } %>
        <% } %>
      </div>
    </div>

    <% if (organizations && organizations.length > 0) { %>
      <div id="organizationsList">
        <% organizations.forEach(org => { %>
          <div class="org-card <%= currentOrgId === org.id ? 'selected' : '' %>"
               data-org-id="<%= org.id %>"
               data-org-name="<%= org.name %>">

            <% if (currentOrgId === org.id) { %>
              <span class="badge bg-success">Current</span>
            <% } %>

            <h3><%= org.name %></h3>

            <div class="meta">
              <i class="bi bi-calendar-event"></i>
              Created <%= new Date(org.created_at).toLocaleDateString() %>

              <% if (org.updated_at && org.updated_at !== org.created_at) { %>
                <span class="ms-3">
                  <i class="bi bi-clock-history"></i>
                  Updated <%= new Date(org.updated_at).toLocaleDateString() %>
                </span>
              <% } %>
            </div>

            <button class="btn btn-select w-100" onclick="selectOrganization('<%= org.id %>', '<%= org.name %>', event)">
              <i class="bi bi-box-arrow-in-right"></i>
              <%= currentOrgId === org.id ? 'Go to Dashboard' : 'Select Organization' %>
            </button>

            <% if (isAdmin) { %>
              <a href="/admin/organization/<%= org.id %>" class="btn btn-outline-secondary w-100 mt-2">
                <i class="bi bi-gear"></i>
                Admin View
              </a>
            <% } %>
          </div>
        <% }); %>
      </div>

      <div class="admin-controls">
        <% if (user) { %>
          <!-- Logged in user controls -->
          <% if (isAdmin) { %>
            <a href="/admin/dashboard" class="btn btn-primary">
              <i class="bi bi-speedometer2"></i> Admin Dashboard
            </a>
          <% } %>

          <a href="/auth/logout" class="btn btn-outline-danger ms-2">
            <i class="bi bi-box-arrow-right"></i> Logout
          </a>
        <% } else { %>
          <!-- Not logged in - show login options -->
          <p class="mb-3 text-muted">
            <i class="bi bi-info-circle"></i>
            To access restricted organizations, please log in first.
          </p>
          <a href="/auth/login" class="btn btn-primary">
            <i class="bi bi-box-arrow-in-right"></i> Login
          </a>
          <a href="/auth/register" class="btn btn-outline-primary ms-2">
            <i class="bi bi-person-plus"></i> Register
          </a>
        <% } %>
      </div>
    <% } else { %>
      <div class="empty-state">
        <i class="bi bi-inbox"></i>
        <h3>No Organizations Found</h3>
        <p>No organizations have completed the setup wizard yet.</p>
        <a href="/setup" class="btn btn-select mt-3">
          <i class="bi bi-plus-circle"></i> Start Setup Wizard
        </a>
      </div>
    <% } %>
  </div>

  <script>
    // ============================================================================
    // MULTI-ORG SESSION STORAGE ENHANCEMENT (TASK 1)
    // ============================================================================

    /**
     * Store last-used organization in localStorage
     */
    function rememberLastOrganization(orgId, orgName) {
      try {
        localStorage.setItem('lastOrgId', orgId);
        localStorage.setItem('lastOrgName', orgName);
        localStorage.setItem('lastOrgTimestamp', new Date().toISOString());
      } catch (e) {
        console.warn('localStorage not available:', e);
      }
    }

    /**
     * Get last-used organization from localStorage
     */
    function getLastOrganization() {
      try {
        const orgId = localStorage.getItem('lastOrgId');
        const orgName = localStorage.getItem('lastOrgName');
        const timestamp = localStorage.getItem('lastOrgTimestamp');

        if (orgId && orgName) {
          return { orgId, orgName, timestamp };
        }
      } catch (e) {
        console.warn('localStorage not available:', e);
      }
      return null;
    }

    /**
     * Select organization and navigate to dashboard
     */
    function selectOrganization(orgId, orgName, event) {
      // Show loading state
      const button = event.target;
      button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Loading...';
      button.disabled = true;

      // Remember this organization for next time
      rememberLastOrganization(orgId, orgName);

      // Send selection to server
      fetch('/auth/select', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ organizationId: orgId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Redirect to dashboard
          window.location.href = '/dashboard';
        } else {
          alert('Error: ' + data.error);
          button.innerHTML = '<i class="bi bi-box-arrow-in-right"></i> Select Organization';
          button.disabled = false;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error selecting organization. Please try again.');
        button.innerHTML = '<i class="bi bi-box-arrow-in-right"></i> Select Organization';
        button.disabled = false;
      });
    }

    // Add click handlers to cards
    document.querySelectorAll('.org-card').forEach(card => {
      card.addEventListener('click', function(e) {
        // Don't trigger if clicking the button
        if (e.target.tagName !== 'BUTTON' && !e.target.closest('button')) {
          const button = this.querySelector('button');
          if (button) button.click();
        }
      });
    });

    // ============================================================================
    // HIGHLIGHT LAST-USED ORGANIZATION ON PAGE LOAD
    // ============================================================================
    document.addEventListener('DOMContentLoaded', function() {
      const lastOrg = getLastOrganization();

      if (lastOrg && lastOrg.orgId) {
        // Find the card for the last-used organization
        const orgCard = document.querySelector(`[data-org-id="${lastOrg.orgId}"]`);

        if (orgCard) {
          // Add visual indicator for last-used org (if not already current)
          const currentOrgId = '<%= currentOrgId %>';
          if (lastOrg.orgId !== currentOrgId) {
            // Add a subtle badge to indicate this was the last-used org
            const badge = document.createElement('span');
            badge.className = 'badge bg-info position-absolute';
            badge.style.top = '1.5rem';
            badge.style.left = '1.5rem';
            badge.innerHTML = '<i class="bi bi-clock-history"></i> Last Used';
            orgCard.style.position = 'relative';
            orgCard.appendChild(badge);

            // Scroll into view if not visible
            orgCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
      }
    });
  </script>
</body>
</html>
